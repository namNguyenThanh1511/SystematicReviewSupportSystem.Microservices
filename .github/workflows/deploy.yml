name: Build image and deploy to k8s

on:
   push:
      branches: ["main"]

jobs:
   build-and-push:
      runs-on: ubuntu-latest
      permissions:
         contents: read
         packages: write
      strategy:
         matrix:
            include:
               # API Gateways
               - service: yarp-gateway
                 context: ./src
                 dockerfile: ./src/ApiGateways/YarpApiGateway/Dockerfile
                 image_name: yarp-api-gateway

               # Services
               - service: iam-service
                 context: ./src
                 dockerfile: ./src/Services/SRSS.IAM/SRSS.IAM.API/Dockerfile
                 image_name: srss-iam-api

               # - service: test-service
               #   context: ./src
               #   dockerfile: ./src/Services/SRSS.TestGateways/SRSS.TestGateways.API/Dockerfile
               #   image_name: srss-test-api

      steps:
         - uses: actions/checkout@v5

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Log in to GitHub Container Registry
           uses: docker/login-action@v3
           with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

         - name: Extract metadata
           id: meta
           uses: docker/metadata-action@v5
           with:
              images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image_name }}
              tags: |
                 type=sha
                 type=raw,value=latest,enable={{is_default_branch}}

         - name: Build and push Docker image
           uses: docker/build-push-action@v5
           with:
              context: ${{ matrix.context }}
              file: ${{ matrix.dockerfile }}
              push: true
              tags: ${{ steps.meta.outputs.tags }}
              labels: ${{ steps.meta.outputs.labels }}
              cache-from: type=gha
              cache-to: type=gha,mode=max

   # deploy-to-k8s:
   #    needs: build-and-push
   #    runs-on: ubuntu-latest
   #    steps:
   #       - name: Checkout code
   #         uses: actions/checkout@v5

   #       - uses: azure/setup-kubectl@v4

   #       - uses: Azure/k8s-set-context@v4
   #         with:
   #            kubeconfig: ${{ secrets.KUBE_CONFIG }}

   #       - uses: Azure/k8s-create-secret@v4
   #         with:
   #            container-registry-url: ghcr.io
   #            container-registry-username: ${{ github.actor }}
   #            container-registry-password: ${{ secrets.GITHUB_TOKEN }}
   #            secret-name: ghcr-secret

   #       - uses: Azure/k8s-deploy@v4
   #         with:
   #            action: deploy
   #            manifests: |
   #               manifests/deployment.yml
   #               manifests/service.yml
   #            images: |
   #               ghcr.io/${{ github.repository_owner }}/yarp-api-gateway:${{ github.sha }}
   #               ghcr.io/${{ github.repository_owner }}/srss-iam-api:${{ github.sha }}
   #               ghcr.io/${{ github.repository_owner }}/srss-test-api:${{ github.sha }}
   #            imagepullsecrets: |
   #               ghcr-secret
